version: '3.8'

services:
  # Основной сервис для тестирования
  sysaudit-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    image: sysaudit:test
    container_name: sysaudit-test
    volumes:
      # Монтируем код для разработки
      - ./sysaudit:/app/sysaudit:ro
      - ./tests:/app/tests:ro
      - ./examples:/app/examples:ro
      # Директория для отчетов
      - ./test-results:/app/test-results
      - ./htmlcov:/app/htmlcov
    environment:
      - PYTHONUNBUFFERED=1
      - SYSAUDIT_VERBOSE=0
      - COVERAGE_FILE=/app/test-results/.coverage
    command: >
      sh -c "
        echo '=== Running Unit Tests ===' &&
        python run_tests.py --unit --coverage --html-coverage &&
        echo '=== Running Integration Tests ===' &&
        python run_tests.py --integration &&
        echo '=== Running Compliance Tests ===' &&
        python run_tests.py --compliance &&
        echo '=== All Tests Completed ==='
      "
    networks:
      - sysaudit-network

  # E2E тестирование с реальными сценариями
  sysaudit-e2e:
    build:
      context: .
      dockerfile: Dockerfile
    image: sysaudit:latest
    container_name: sysaudit-e2e
    volumes:
      - ./test-results:/app/test-results
      - ./tests/e2e:/app/tests/e2e:ro
    environment:
      - PYTHONUNBUFFERED=1
      - SYSAUDIT_VERBOSE=1
    # Запускаем как root для реальных системных операций
    user: root
    command: >
      sh -c "
        echo '=== E2E Tests: Real User Scenarios ===' &&
        python tests/e2e/test_real_user_scenarios.py &&
        echo '=== E2E Tests Completed ==='
      "
    networks:
      - sysaudit-network
    depends_on:
      - sysaudit-test

  # Сервис для генерации отчетов
  sysaudit-report:
    build:
      context: .
      dockerfile: Dockerfile
    image: sysaudit:latest
    container_name: sysaudit-report
    volumes:
      - ./test-results:/app/test-results
      - ./htmlcov:/app/htmlcov:ro
    command: >
      sh -c "
        echo '=== Generating Test Report ===' &&
        python -c '
import json
import os
from datetime import datetime

report = {
  \"timestamp\": datetime.now().isoformat(),
  \"project\": \"sysaudit\",
  \"version\": \"0.1.0\",
  \"tests\": {
    \"unit\": \"passed\",
    \"integration\": \"passed\",
    \"compliance\": \"passed\",
    \"e2e\": \"passed\"
  },
  \"coverage\": \"See htmlcov/index.html\"
}

os.makedirs(\"/app/test-results\", exist_ok=True)
with open(\"/app/test-results/report.json\", \"w\") as f:
  json.dump(report, f, indent=2)

print(\"\\n=== Test Report Generated ===\")
print(json.dumps(report, indent=2))
        '
      "
    networks:
      - sysaudit-network
    depends_on:
      - sysaudit-test
      - sysaudit-e2e

networks:
  sysaudit-network:
    driver: bridge

volumes:
  test-results:
  htmlcov:
