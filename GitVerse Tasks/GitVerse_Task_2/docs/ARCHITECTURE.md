# Архитектура GitConfig

## Обзор

GitConfig - это распределённое key-value хранилище, использующее Git как transport layer и storage backend. Система обеспечивает eventual consistency между узлами через Git push/pull механизмы.

## Компоненты

### 1. GitConfigStore (gitconfig_core.py)

Основной класс для работы с хранилищем:

- **Хранение данных**: Ключи хранятся как файлы в иерархической структуре директорий
- **Git интеграция**: Каждая операция создаёт Git commit
- **Синхронизация**: Автоматический pull/push между узлами
- **Conflict Resolution**: Last-write-wins стратегия при конфликтах
- **TTL**: Автоматическое удаление ключей по истечении времени
- **Watch**: Механизм подписки на изменения ключей

### 2. GitConfigNode (gitconfig_node.py)

HTTP API сервер:

- RESTful API для операций с ключами
- Структурированное логирование (JSON)
- Graceful shutdown
- Поддержка всех операций через HTTP

### 3. CLI (gitconfig_cli.py)

Интерфейс командной строки:

- Локальные операции (прямой доступ к репозиторию)
- Удалённые операции (через HTTP API)
- Все основные команды: set, get, delete, list, history, watch, cas

## Архитектура хранения

```
repo/
├── .git/                    # Git репозиторий
├── app/                     # Иерархия ключей
│   ├── db/
│   │   ├── host            # Файл со значением
│   │   └── port
│   └── api/
│       └── endpoint
├── system/
│   └── hostname
└── .ttl_metadata.json      # Метаданные TTL
```

## Синхронизация

### Топология

Система поддерживает различные топологии:

1. **Star**: Центральный bare repository, узлы синхронизируются с ним
2. **Mesh**: Каждый узел может быть remote для других

### Процесс синхронизации

1. Периодический pull от remote (каждые N секунд)
2. Автоматическое разрешение конфликтов
3. Push изменений обратно

### Conflict Resolution

При конфликте используется стратегия **last-write-wins**:

1. Детектируется merge conflict
2. Парсятся conflict markers
3. Выбирается версия из remote (theirs)
4. Создаётся merge commit

## Реализованная функциональность

### Базовый уровень (12 баллов)
✅ set/get/delete с Git commits
✅ Иерархические ключи

### Средний уровень (19 баллов)
✅ Синхронизация между узлами (manual push/pull)
✅ Автоматический периодический pull
✅ HTTP API (GET/POST/DELETE)
✅ Версионирование (get --commit)
✅ История изменений (history)
✅ Базовый conflict resolution

### Продвинутый уровень (15 баллов)
✅ Watch mechanism
✅ TTL (Time-To-Live)
✅ Production-quality логирование
✅ Graceful shutdown

### Экспертный уровень (4 балла)
✅ Compare-and-Swap (CAS)


## Многопоточность

- `threading.RLock` для защиты критических секций
- Фоновые потоки для:
  - Автоматической синхронизации
  - TTL cleanup
- Thread-safe операции с Git репозиторием

## Производительность

- Кеширование не требуется (Git эффективен)
- Батчинг не реализован (можно добавить)
- Индексирование через Git index

## Безопасность

- Структурированное логирование без PII
- Graceful shutdown с сохранением состояния
- Атомарные операции через Git
